
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Allison Kaptur</title>
  <meta name="author" content="akaptur">

  
  <meta name="description" content="I hit a very fun bug yesterday while trying to run a script that sends emails to certain subsets of Hacker Schoolers. When I tried to test the script &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://akaptur.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Allison Kaptur" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42870230-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Allison Kaptur</a></h1>
  
    <h2>An occasional blog on programming</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:akaptur.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/talks">Talks</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/21/debugging-with-pstree/">Debugging With Pstree</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-21T17:46:00-04:00" pubdate data-updated="true">Sep 21<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I hit a very fun bug yesterday while trying to run a script that sends emails to certain subsets of Hacker Schoolers. When I tried to test the script locally, I discovered that one of the tables of the database, <code>Batch</code>, was missing from my local version.  After briefly panicking and making sure that the actual site was still up, I could dig in.</p>

<p>It turns out that my local version of psql was way out of date, and as of a few days ago we&rsquo;d started using a data type that wasn&rsquo;t present in my old version. Because of that, creating that particular table failed when I pulled from the production database the night before. The failure was logged, but the output is so verbose that I didn&rsquo;t notice the problem. Both the diagnosis and the fix here were easy &ndash; I went back and read the logs, googled the data type that was raising an error, and then upgraded Postgres.app and psql. That&rsquo;s when the real trouble started.</p>

<p>The new version of Postgres.app was placed in a new spot on the $PATH, as you&rsquo;d expect, and the upgrade prompted me to change my <code>.bashrc</code>, which I did. But the rake tasks we use to manage local copies of the database errored out with this message:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ pg_restore --verbose --clean --no-acl --no-owner -h localhost -U `whoami` -d hackerschool latest.dump
</span><span class='line'>sh: pg_restore: command not found
</span></code></pre></td></tr></table></div></figure>


<p>This was pretty clearly a $PATH problem. I tried the usual things first, like sourcing my <code>.bashrc</code> in the terminal I was using, closing the terminal and opening a new one, etc. None of that worked.</p>

<p>One thing that jumped out to me was the <code>sh</code> in the error message. That was an indicator that rake wasn&rsquo;t using bash as a shell &ndash; it was using <code>sh</code> &ndash; which means my <code>.bashrc</code> wasn&rsquo;t setting the environment. Reading the rake task showed that it was a thin wrapper around lots of system calls via Ruby&rsquo;s <code>system("cmd here")</code>. I added the line <code>system("echo $PATH")</code> and verified that the new location of <code>pg_restore</code> wasn&rsquo;t in it.</p>

<p>At this point I found I had lots of questions about the execution context of the rake task. Since I was making system calls and could easily edit the rakefile, I added in the line <code>system("sh")</code> to drop me into a shell mid-execution. This turned out to be an efficient way to figure out what was going on (and made me feel like a badass hacker).</p>

<p>From within in that shell, I could do <code>$$</code> to get that process&rsquo;s PID, then repeatedly do <code>ps -ef | grep [PID]</code> to find the parent process.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sh-3.2$ $$
</span><span class='line'>sh: 34652: command not found
</span><span class='line'>sh-3.2$ ps -ef | grep 34652
</span><span class='line'>  501 34652 34639   0  4:18PM ??         0:00.04 sh
</span><span class='line'>    0 34881 34652   0  4:26PM ??         0:00.01 ps -ef
</span><span class='line'>  501 34882 34652   0  4:26PM ??         0:00.01 grep 34652
</span><span class='line'>sh-3.2$ ps -ef | grep 34639
</span><span class='line'>  501 34639  2914   0  4:18PM ??         0:00.41 rake db:drop db:create db:pull
</span><span class='line'>  501 34652 34639   0  4:18PM ??         0:00.04 sh
</span><span class='line'>  501 34885 34652   0  4:28PM ??         0:00.00 grep 34639
</span><span class='line'>sh-3.2$ ps -ef | grep 2914
</span><span class='line'>  501  2914  2913   0 10Sep14 ??        27:11.72 spring app    | hackerschool | started 244 hours ago | development mode
</span><span class='line'>  501 34639  2914   0  4:18PM ??         0:00.41 rake db:drop db:create db:pull
</span><span class='line'>  501 34889 34652   0  4:28PM ??         0:00.01 grep 2914
</span><span class='line'>sh-3.2$ ps -ef | grep 2913
</span><span class='line'>  501  2914  2913   0 10Sep14 ??        27:11.98 spring app    | hackerschool | started 244 hours ago | development mode
</span><span class='line'>  501 34892 34652   0  4:29PM ??         0:00.00 grep 2913
</span><span class='line'>  501  2913     1   0 10Sep14 ttys001    0:00.94 spring server | hackerschool | started 244 hours ago
</span></code></pre></td></tr></table></div></figure>


<p>Aha! The parent process of the rake task I was running is the spring server, which starts on boot &ndash; several days ago, at the time &ndash; and doesn&rsquo;t have the new and updated $PATH information.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> A kick to the spring server (with <code>kill 2913</code>) forced the server process to restart with the new environment.</p>

<p>It turns out there&rsquo;s a handy utility called <code>pstree</code><sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> (brew installable) to visualize the tree of processes. This would have saved me a couple of steps of grepping. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>hackerschool [master] $ pstree -p 35351
</span><span class='line'>-+= 00001 root /sbin/launchd
</span><span class='line'> \-+- 35129 afk spring server | hackerschool | started 25 hours ago
</span><span class='line'>   \-+= 35130 afk spring app    | hackerschool | started 25 hours ago | development mode
</span><span class='line'>     \--- 35351 afk rails_console
</span></code></pre></td></tr></table></div></figure>


<p>This bug and some related ones have gotten me more interested in operating systems, and I&rsquo;ve started reading the book <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/">Operating Systems: Three Easy Pieces</a>. I&rsquo;m only a few chapters in, but so far it&rsquo;s readable, clear, and entertaining. I look forward to building up my mental model of processes and environments as I keep reading it.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>We can tell it (probably) starts on boot because the parent process ID is 1. This means that rebooting my computer would have solved the problem.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>Thanks to <a href="//twitter.com/paultag">Paul Tag</a> for the pointer to <code>pstree</code>.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/11/rejected-pycon-proposals/">Rejected PyCon Proposals</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-11T15:38:00-04:00" pubdate data-updated="true">Sep 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>&ldquo;All accepted proposals are alike, but each rejected proposal is rejected in its own way&rdquo; &ndash; Tolstoy, if he were on the PyCon talk review committee</p></blockquote>

<p>I&rsquo;m building a collection of <a href="https://github.com/akaptur/pycon-proposals">old PyCon talk proposals</a>, particularly rejected ones.  I think rejected proposals are more interesting than accepted ones, for a couple of reasons:</p>

<h4>See examples of anti-patterns</h4>

<p>Flipping through these proposals, you can see concrete examples of the talk committee&rsquo;s <a href="https://us.pycon.org/2015/speaking/proposal_advice/">suggestions for what to avoid</a>. There is an example of a &ldquo;state of our project&rdquo; talk and one of &ldquo;here&rsquo;s some code I hope to have written by the time the conference rolls around.&rdquo;</p>

<h4>&ldquo;I can do better than that&rdquo;</h4>

<p>Being a great or famous programmer doesn&rsquo;t mean you&rsquo;ll give a great talk or submit a great proposal. You&rsquo;ll notice that you can write a better proposal than some of the ones from people you&rsquo;ve heard of. (This fits with the <a href="http://juliepagano.com/blog/2013/11/02/it-s-dangerous-to-go-alone-battling-the-invisible-monsters-in-tech/">Kill your heroes</a> theme from Julie Pagano&rsquo;s great talk on impostor syndrome at PyCon 2014.)</p>

<h4>Empathize with the talk committee</h4>

<p>Any application is an exercise in empathy &ndash; you need to imagine what the people who will be reading your submission are thinking. What do they care about? Where are they coming from? You can read past proposals and decide if you&rsquo;d make the same decision the committee did. When submitters have shared the feedback they received, you can see <em>exactly</em> what the committee members thought. This helps you write a proposal that will address their concerns.</p>

<p>The deadline for submitting a proposal is Monday, September 15th. I encourage you to browse through the collection of past proposals to get inspiration or to improve your proposal. Once you&rsquo;ve submitted a proposal, please <a href="https://github.com/akaptur/pycon-proposals/pulls">add it to the collection!</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/03/getting-started-with-python-internals/">Getting Started With Python Internals</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-03T09:17:00-04:00" pubdate data-updated="true">Aug 3<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I talk to a lot of people at Hacker School and elsewhere who have been programming Python for some time and want to get a better mental model of what&rsquo;s happening under the hood.  The words &ldquo;really&rdquo; or &ldquo;why&rdquo; often features in these questions &ndash; &ldquo;What&rsquo;s <em>really</em> happening when I write a list comprehension?&rdquo; &ldquo;Why are function calls considered expensive?&rdquo; If you&rsquo;ve seen any of the rest of this blog, you know I love digging around in Python internals, and I&rsquo;m always happy to share that with others.</p>

<h2>Why do this?</h2>

<p>First off, I reject the idea that you <em>have</em> to understand the internals of Python to be a good Python developer. Many of the things you&rsquo;ll learn about Python won&rsquo;t help you write better Python. The &ldquo;under the hood&rdquo; construction is specious, too &ndash; why stop at Python internals? Do you also need to know C perfectly, and the C compiler, and the assembly, and &hellip;</p>

<p>That said, I think you should dig around in Python &ndash; it sometimes will help you write better Python, you&rsquo;ll be more prepared to contribute to Python if you want to, and most importantly, it&rsquo;s often really interesting and fun.</p>

<h2>Setup</h2>

<p>Follow the instructions in the <a href="https://docs.python.org/devguide/setup.html">Python dev guide</a> under &ldquo;Version Control Setup&rdquo; and &ldquo;Getting the Source Code&rdquo;. You now have a Python that you can play with.</p>

<h2>Strategies</h2>

<h4>1. Naturalism</h4>

<p>Peter Seibel has a <a href="//www.gigamonkeys.com/code-reading/">great blog post</a> about reading code. He thinks that &ldquo;reading&rdquo; isn&rsquo;t how most people interact with code &ndash; instead, they dissect it. From the post:</p>

<blockquote><p>But then it hit me. Code is not literature and we are not readers. Rather, interesting pieces of code are specimens and we are naturalists. So instead of trying to pick out a piece of code and reading it and then discussing it like a bunch of Comp Lit. grad students, I think a better model is for one of us to play the role of a 19th century naturalist returning from a trip to some exotic island to present to the local scientific society a discussion of the crazy beetles they found: “Look at the antenna on this monster! They look incredibly ungainly but the male of the species can use these to kill small frogs in whose carcass the females lay their eggs.”</p>

<p>The point of such a presentation is to take a piece of code that the presenter has understood deeply and for them to help the audience understand the core ideas by pointing them out amidst the layers of evolutionary detritus (a.k.a. kluges) that are also part of almost all code. One reasonable approach might be to show the real code and then to show a stripped down reimplementation of just the key bits, kind of like a biologist staining a specimen to make various features easier to discern.</p></blockquote>

<h4>2. Science!</h4>

<p>I&rsquo;m a big fan of hypothesis-driven debugging, and that also applies in exploring Python.  I think you <em>should not</em> just sit down and read CPython at random. Instead, enter the codebase with (1) a question and (2) a hypothesis. For each thing you&rsquo;re wondering about, make a guess for how it might be implemented, then try to confirm or refute your guess.</p>

<h4>3. Guided tours</h4>

<p>Follow a step-by-step guide to changing something in Python. I like <a href="//mathamy.com/import-accio-bootstrapping-python-grammar.html">Amy Hanlon&rsquo;s post</a> on changing a keyword in Python and <a href="//eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/">Eli Bendersky&rsquo;s</a> on adding a keyword.</p>

<h4>4. Reading recommendations.</h4>

<p>I don&rsquo;t think you should sit down and read CPython at random, but I do have some suggestions for my favorite modules that are implemented in Python. I think you should read the implementation of</p>

<h5>1. <code>timeit</code> in <code>Lib/timeit.py</code></h5>

<h5>2. <code>namedtuple</code> in <code>Lib/collections.py</code>.</h5>

<p>If you have a favorite module implemented in Python, <a href="//twitter.com/akaptur">tweet at me</a> and I&rsquo;ll add it to this list.</p>

<h4>5. Blog &amp; talk</h4>

<p>Did you learn something interesting? Write it up and share it, or present at your local meetup group! It&rsquo;s easy to feel like everyone else already knows everything you know, but trust me, they don&rsquo;t.</p>

<h4>6. Rewrite</h4>

<p>Try to write your own implementation of <code>timeit</code> or <code>namedtuple</code> before reading the implementation.  Or read a bit of C and rewrite the logic in Python. <a href="//github.com/nedbat/byterun">Byterun</a> is an example of the latter strategy.</p>

<h2>Tools</h2>

<p>I sometimes hesitate to recommend tooling because it&rsquo;s so easy to get stuck on installation problems. If you&rsquo;re having trouble installing something, get assistance (IRC, StackOverflow, a Meetup, etc.)  These problems are challenging to fix if you haven&rsquo;t seen them before, but often straightforward once you know what you&rsquo;re looking for. If you don&rsquo;t believe me, <a href="//mail.python.org/pipermail/python-dev/2014-February/132313.html">this thread</a> features Guido van Rossum totally misunderstanding a problem he&rsquo;s having with a module that turns out to be related to upgrading to OS X Mavericks. <em>This stuff is hard.</em></p>

<h4>1. Ack</h4>

<p>I&rsquo;d been using <code>grep</code> in the CPython codebase, which was noticeably slow. (It&rsquo;s especially slow when you forget to add the <code>.</code> at the end of the command and grep patiently waits on stdin, a mistake I manage to make <em>all the time</em>.) I started using <a href="//beyondgrep.com/">ack</a> a few months ago and really like it.</p>

<p>If you&rsquo;re on a Mac and use homebrew, you can <code>brew install ack</code>, which takes only a few seconds. Then do <code>ack string_youre_looking_for</code> and you get a nicely-formatted output. I imagine you could get the same result with <code>grep</code> if you knew the right options to pass it, but I find ack fast and simple.</p>

<p>Try using <code>ack</code> on <a href="/blog/2014/06/11/of-syntax-warnings-and-symbol-tables/">the text of an error message</a> or <a href="//acmonette.com/here-there-be-pydras.html">a mysterious constant</a>. You may be surprised how often this leads you directly to the relevant source code.</p>

<h4>2. timeit</h4>

<p>Timing &amp; efficiency questions are a great place to use the &ldquo;Science!&rdquo; strategy. You may have a question like &ldquo;Which is faster, X or Y?&rdquo; For example, is it faster to do two assignment statements in a row, or do both in one tuple-unpacking assignment? I&rsquo;m guessing that the tuple-unpacking will take longer because of the unpacking step. Let&rsquo;s find out!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>~ ⚲ python -m timeit &quot;x = 1; y = 2&quot;
</span><span class='line'>10000000 loops, best of 3: 0.0631 usec per loop
</span><span class='line'>~ ⚲ python -m timeit &quot;x, y = 1, 2&quot;
</span><span class='line'>10000000 loops, best of 3: 0.0456 usec per loop
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m wrong! Interesting! I wonder why that is. What if instead of unpacking a tuple, we did &hellip;</p>

<p>A lot of people I talk to like using IPython for timing. IPython is pip-installable, and it usually installs smoothly into a virtual environment. In the IPython REPL, you can use <code>%timeit</code> for timing questions. There are also other <a href="//ipython.org/ipython-doc/dev/interactive/tutorial.html#magic-functions">magic functions</a> available in IPython.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="mi">10000000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">82.3</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span>
</span><span class='line'>
</span><span class='line'><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">10000000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">47.3</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span>
</span></code></pre></td></tr></table></div></figure>


<p>One caveat on timing stuff &ndash; use <code>timeit</code> to enhance your understanding, but unless you have real speed problems, you should write code for clarity, not for miniscule speed gains like this one.</p>

<h4>3. Disassembling</h4>

<p>Python compiles down to bytecode, an intermediate representation of your Python code used by the Python virtual machine.  It&rsquo;s sometimes enlightening and often fun to look at that bytecode using the built-in <code>dis</code> module.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="o">...</span>     <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">dis</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">3</span>           <span class="mi">6</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">9</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">12</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">15</span> <span class="n">RETURN_VALUE</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">two</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">3</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">UNPACK_SEQUENCE</span>          <span class="mi">2</span>
</span><span class='line'>              <span class="mi">6</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">9</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">12</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">15</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>The implementation of the various operations are in <code>Python/ceval.c</code>.</p>

<h4>4. Inspect/cinspect</h4>

<p>You can get into the habit of trying to call <code>inspect</code> on anything you&rsquo;re curious about to see the source code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">inspect</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">collections</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">namedtuple</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">rename</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span class='line'>    <span class="s">&quot;&quot;&quot;Returns a new subclass of tuple with named fields.</span>
</span><span class='line'><span class="s">    ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, <code>inspect</code> will only show the source code of things that are implemented in Python, which can be frustrating.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">)</span>
</span><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>   <span class="p">[</span><span class="o">...</span> <span class="n">snip</span> <span class="o">...</span><span class="p">]</span>
</span><span class='line'><span class="ne">IOError</span><span class="p">:</span> <span class="n">could</span> <span class="ow">not</span> <span class="n">find</span> <span class="k">class</span> <span class="nc">definition</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="p">:(</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get around this, <a href="//github.com/punchagan">Puneeth Chaganti</a> wrote a tool called <a href="//github.com/punchagan/cinspect">cinspect</a> that extends <code>inspect</code> to work reasonably consistently with C-implemented code as well.</p>

<h4>5. K&amp;R</h4>

<p>I think C is about a hundred times easier to read than it is to write, so I encourage you to read C code even if you don&rsquo;t totally know what&rsquo;s going on. That said, I think an afternoon spent with the first few chapters of <a href="//www.amazon.com/The-Programming-Language-2nd-Edition/dp/0131103628">K&amp;R</a> would take you pretty far.  <a href="//www.amazon.com/Hacking-The-Art-Exploitation-Edition/dp/1593271441">Hacking: The Art of Exploitation</a> is another fun, if less direct, way to learn C.</p>

<h2>Get started!</h2>

<p>CPython is a huge codebase, and you should expect that building a mental model of it will be a long process. Download the source code now and begin poking around, spending five or ten minutes when you&rsquo;re curious about something. Over time, you&rsquo;ll get faster and more rigorous, and the process will get easier.</p>

<p>Do you have recommended strategies and tools that don&rsquo;t appear here? <a href="//twitter.com/akaptur">Let me know!</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/02/the-cpython-peephole-optimizer-and-you/">The CPython Peephole Optimizer and You</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-02T11:25:00-04:00" pubdate data-updated="true">Aug 2<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last Thursday I gave a lightning talk at <a href="//www.hackerschool.com">Hacker School</a> about the peephole optimizer in Python.  A &ldquo;peephole optimization&rdquo; is a compiler optimization that looks at a small chunk of code at a time and optimizes in that little spot. This post explains one surprising side-effect of an optimization in CPython.</p>

<h2>Writing a test coverage tool</h2>

<p>Suppose that we&rsquo;re setting out to write a test coverage tool. Python provides an easy way to trace execution using <code>sys.settrace</code>, so a simple version of a coverage analyzer isn&rsquo;t too hard.</p>

<p>Our code to test is one simple function:</p>

<figure class='code'><figcaption><span>example.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">iffer</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">3</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">10</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we&rsquo;ll write the world&rsquo;s simplest testing framework:</p>

<figure class='code'><figcaption><span>tests.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">example</span> <span class="kn">import</span> <span class="n">iffer</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_iffer</span><span class="p">():</span>
</span><span class='line'>    <span class="k">assert</span> <span class="n">iffer</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</span><span class='line'>    <span class="k">assert</span> <span class="n">iffer</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">run_tests</span><span class="p">():</span>
</span><span class='line'>    <span class="n">test_iffer</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now for the simplest possible coverage tool. We can pass <code>sys.settrace</code> any tracing function, and it&rsquo;ll be called with the arguments <code>frame</code>, <code>event</code>, and <code>arg</code> every time an event happens in the execution.  Lines of code being executed, function calls, function returns, and exceptions are all events. We&rsquo;ll filter out everything but <code>line</code> and <code>call</code> events, then keep track of what line of code was executing.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> Then we run the tests while the trace function is tracing, and finally report which (non-empty lines) failed to execute.</p>

<figure class='code'><figcaption><span>coverage.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">tests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">inspect</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TinyCoverage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_to_watch</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">source_file</span> <span class="o">=</span> <span class="n">file_to_watch</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">source_code</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_to_watch</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">executed_code</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>        <span class="n">current_file</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">filename</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_file</span> <span class="ow">in</span> <span class="n">current_file</span> <span class="ow">and</span> \
</span><span class='line'>            <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s">&quot;line&quot;</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&quot;call&quot;</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">executed_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">unexecuted_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">skipped</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">line_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_code</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">line_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_code</span><span class="p">:</span>
</span><span class='line'>                <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_code</span><span class="p">[</span><span class="n">line_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">src</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
</span><span class='line'>                    <span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_num</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">skipped</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">skipped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unexecuted_code</span><span class="p">()</span>
</span><span class='line'>        <span class="n">percent_skipped</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_code</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">skipped</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;{} line(s) did not execute ({:.0%})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped</span><span class="p">),</span> <span class="n">percent_skipped</span><span class="p">)</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">line_num</span> <span class="ow">in</span> <span class="n">skipped</span><span class="p">:</span>
</span><span class='line'>                <span class="k">print</span> <span class="n">line_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_code</span><span class="p">[</span><span class="n">line_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;100</span><span class="si">% c</span><span class="s">overage, go you!&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">t</span> <span class="o">=</span> <span class="n">TinyCoverage</span><span class="p">(</span><span class="s">&#39;example.py&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tests</span><span class="o">.</span><span class="n">run_tests</span><span class="p">()</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try it.  We&rsquo;re pretty confident in our test coverage &ndash; there are only two branches in the code, and we&rsquo;ve tested both of them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>peephole [master *] ⚲ python coverage.py
</span><span class='line'>1 line(s) did not execute (9%)
</span><span class='line'>4     else:
</span></code></pre></td></tr></table></div></figure>


<p>Why didn&rsquo;t the <code>else</code> line execute? To answer this, we&rsquo;ll run our function through the disassembler.<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt;&gt; from example import iffer
</span><span class='line'>&gt;&gt;&gt; import dis
</span><span class='line'>&gt;&gt;&gt; dis.dis(iffer)
</span><span class='line'>  2           0 LOAD_FAST                0 (condition)
</span><span class='line'>              3 POP_JUMP_IF_FALSE       10
</span><span class='line'>
</span><span class='line'>  3           6 LOAD_CONST               1 (3)
</span><span class='line'>              9 RETURN_VALUE
</span><span class='line'>
</span><span class='line'>  5     &gt;&gt;   10 LOAD_CONST               2 (10)
</span><span class='line'>             13 RETURN_VALUE
</span><span class='line'>             14 LOAD_CONST               0 (None)
</span><span class='line'>             17 RETURN_VALUE
</span></code></pre></td></tr></table></div></figure>


<p>You don&rsquo;t need to follow exactly what&rsquo;s going on in this bytecode, but note that the first column is the line numbers of source code and line 4, the one containing the <code>else</code>, doesn&rsquo;t appear. Why not? Well, there&rsquo;s nothing to <em>do</em> with an else statement &ndash; it&rsquo;s just a separator between two branches of an <code>if</code> statement. The second line in the disassembly, <code>POP_JUMP_IF_FALSE   10</code>, means that the interpreter will pop the top thing off of the virtual machine stack, jump to bytecode index ten if that thing is false, or continue with the next instruction if it&rsquo;s true.</p>

<p>From the bytecode&rsquo;s perspective, there&rsquo;s no difference at all between writing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">if</span> <span class="n">a</span><span class="p">:</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
</span><span class='line'>       <span class="o">...</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>and this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">if</span> <span class="n">a</span><span class="p">:</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="k">elif</span> <span class="n">b</span><span class="p">:</span>
</span><span class='line'>   <span class="o">...</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>(even though the second is better style).</p>

<p>We&rsquo;ve learned we need to special-case <code>else</code> statements in our code coverage tool.  Since there&rsquo;s no logic in them, let&rsquo;s just drop lines that only contain <code>else:</code>. We can revise our <code>unexecuted_code</code> method accordingly:</p>

<figure class='code'><figcaption><span>coverage.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">unexecuted_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="n">skipped</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">line_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_code</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">line_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_code</span><span class="p">:</span>
</span><span class='line'>            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_code</span><span class="p">[</span><span class="n">line_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">src</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">and</span> <span class="s">&quot;else:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>  <span class="c"># Add &quot;else&quot; dropping</span>
</span><span class='line'>                <span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_num</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">skipped</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run it again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>peephole [master *] ⚲ python coverage.py
</span><span class='line'>100% coverage, go you!
</span></code></pre></td></tr></table></div></figure>


<p>Success!</p>

<h2>Complications arise</h2>

<p>Our previous example was really simple. Let&rsquo;s add a more complex one.</p>

<figure class='code'><figcaption><span>example.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">iffer</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">3</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">continuer</span><span class="p">():</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>                <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="n">b</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>continuer</code> will increment <code>a</code> on all odd numbers and increment <code>b</code> and <code>c</code> for all even numbers. Don&rsquo;t forget to add a test:</p>

<figure class='code'><figcaption><span>tests.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">inspect</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">example2</span> <span class="kn">import</span> <span class="n">iffer</span><span class="p">,</span> <span class="n">continuer</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_iffer</span><span class="p">():</span>
</span><span class='line'>    <span class="k">assert</span> <span class="n">iffer</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</span><span class='line'>    <span class="k">assert</span> <span class="n">iffer</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_continuer</span><span class="p">():</span>
</span><span class='line'>    <span class="k">assert</span> <span class="n">continuer</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">run_tests</span><span class="p">():</span>
</span><span class='line'>    <span class="n">test_iffer</span><span class="p">()</span>
</span><span class='line'>    <span class="n">test_continuer</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>peephole [master *] ⚲ python coverage2.py
</span><span class='line'>1 line(s) did not execute (4%)
</span><span class='line'>13             continue
</span></code></pre></td></tr></table></div></figure>


<p>Hmm. The test we wrote certainly did involve the <code>continue</code> statement &ndash; if the interpreter hadn&rsquo;t skipped the bottom half of the loop, the test wouldn&rsquo;t have passed. Let&rsquo;s use the strategy we used before to understand what&rsquo;s happening: examining the output of the disassembler.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">continuer</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">8</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">DUP_TOP</span>
</span><span class='line'>              <span class="mi">4</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">7</span> <span class="n">DUP_TOP</span>
</span><span class='line'>              <span class="mi">8</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">11</span> <span class="n">STORE_FAST</span>               <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">9</span>          <span class="mi">14</span> <span class="n">SETUP_LOOP</span>              <span class="mi">79</span> <span class="p">(</span><span class="n">to</span> <span class="mi">96</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">17</span> <span class="n">LOAD_GLOBAL</span>              <span class="mi">0</span> <span class="p">(</span><span class="nb">range</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">20</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">23</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">1</span>
</span><span class='line'>             <span class="mi">26</span> <span class="n">GET_ITER</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span>   <span class="mi">27</span> <span class="n">FOR_ITER</span>                <span class="mi">65</span> <span class="p">(</span><span class="n">to</span> <span class="mi">95</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">30</span> <span class="n">STORE_FAST</span>               <span class="mi">3</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'> <span class="mi">10</span>          <span class="mi">33</span> <span class="n">LOAD_FAST</span>                <span class="mi">3</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">36</span> <span class="n">LOAD_CONST</span>               <span class="mi">3</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">39</span> <span class="n">BINARY_MODULO</span>
</span><span class='line'>             <span class="mi">40</span> <span class="n">POP_JUMP_IF_FALSE</span>       <span class="mi">72</span>
</span><span class='line'>
</span><span class='line'> <span class="mi">11</span>          <span class="mi">43</span> <span class="n">LOAD_FAST</span>                <span class="mi">3</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">46</span> <span class="n">LOAD_CONST</span>               <span class="mi">4</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">49</span> <span class="n">BINARY_MODULO</span>
</span><span class='line'>             <span class="mi">50</span> <span class="n">POP_JUMP_IF_FALSE</span>       <span class="mi">27</span>
</span><span class='line'>
</span><span class='line'> <span class="mi">12</span>          <span class="mi">53</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">56</span> <span class="n">LOAD_CONST</span>               <span class="mi">5</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">59</span> <span class="n">INPLACE_ADD</span>
</span><span class='line'>             <span class="mi">60</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">63</span> <span class="n">JUMP_ABSOLUTE</span>           <span class="mi">27</span>
</span><span class='line'>
</span><span class='line'> <span class="mi">13</span>          <span class="mi">66</span> <span class="n">JUMP_ABSOLUTE</span>           <span class="mi">27</span>
</span><span class='line'>             <span class="mi">69</span> <span class="n">JUMP_FORWARD</span>            <span class="mi">10</span> <span class="p">(</span><span class="n">to</span> <span class="mi">82</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'> <span class="mi">15</span>     <span class="o">&gt;&gt;</span>   <span class="mi">72</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">75</span> <span class="n">LOAD_CONST</span>               <span class="mi">5</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">78</span> <span class="n">INPLACE_ADD</span>
</span><span class='line'>             <span class="mi">79</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'> <span class="mi">16</span>     <span class="o">&gt;&gt;</span>   <span class="mi">82</span> <span class="n">LOAD_FAST</span>                <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">85</span> <span class="n">LOAD_CONST</span>               <span class="mi">5</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">88</span> <span class="n">INPLACE_ADD</span>
</span><span class='line'>             <span class="mi">89</span> <span class="n">STORE_FAST</span>               <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">92</span> <span class="n">JUMP_ABSOLUTE</span>           <span class="mi">27</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span>   <span class="mi">95</span> <span class="n">POP_BLOCK</span>
</span><span class='line'>
</span><span class='line'> <span class="mi">18</span>     <span class="o">&gt;&gt;</span>   <span class="mi">96</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">99</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>            <span class="mi">102</span> <span class="n">LOAD_FAST</span>                <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>            <span class="mi">105</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">3</span>
</span><span class='line'>            <span class="mi">108</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s a lot more going on here, but you don&rsquo;t need to understand all of it to proceed. Here are the things we need to know to make sense of this:</p>

<ul>
<li>The second column in the output is the index in the bytecode, the third is the byte name, and the fourth is the argument.  The fifth, when present, is a hint about the meaning of the argument.</li>
<li><code>POP_JUMP_IF_FALSE</code>, <code>POP_JUMP_IF_TRUE</code>, and <code>JUMP_ABSOLUTE</code> have the jump target as their argument. So, e.g. <code>POP_JUMP_IF_TRUE 27</code> means &ldquo;if the popped expression is true, jump to position 27.&rdquo;</li>
<li><code>JUMP_FORWARD</code>&rsquo;s argument specifies the distance to jump forward in the bytecode, and the fifth column shows where the jump will end.</li>
<li>When an iterator is done, <code>FOR_ITER</code> jumps forward the number of bytes specified in its argument.</li>
</ul>


<p>Unlike the <code>else</code> case, the line containing the <code>continue</code> does appear in the bytecode. But trace through the bytecode using what you know about jumps: no matter how hard you try, you can&rsquo;t end up on bytes 66 or 69, the two that belong to line 13.</p>

<p>The <code>continue</code> is unreachable because of a compiler optimization. In this particular optimization, the compiler notices that two instructions in a row are jumps, and it combines these two hops into one larger jump. So, in a very real sense, the <code>continue</code> line didn&rsquo;t execute &ndash; it was optimized out &ndash; even though the logic reflected in the <code>continue</code> is still reflected in the bytecode.</p>

<p>What would this bytecode have looked like without the optimizations? There&rsquo;s not currently an option to disable the peephole bytecode optimizations, although there will be in a future version of Python (following an <a href="//mail.python.org/pipermail/python-ideas/2014-May/027893.html">extensive debate</a> on the python-dev list). For now, the only way to turn off optimizations is to comment out the relevant line in <code>compile.c</code>, the call to <code>PyCode_Optimize</code>, and recompile Python. Here&rsquo;s the diff, if you&rsquo;re playing along at home.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'>cpython ⚲ hg diff
</span><span class='line'><span class="gh">diff -r 77f36cdb71b0 Python/compile.c</span>
</span><span class='line'><span class="gd">--- a/Python/compile.c  Fri Aug 01 17:48:34 2014 +0200</span>
</span><span class='line'><span class="gi">+++ b/Python/compile.c  Sat Aug 02 15:43:45 2014 -0400</span>
</span><span class='line'><span class="gu">@@ -4256,10 +4256,6 @@</span>
</span><span class='line'>     if (flags &lt; 0)
</span><span class='line'>         goto error;
</span><span class='line'>
</span><span class='line'><span class="gd">-    bytecode = PyCode_Optimize(a-&gt;a_bytecode, consts, names, a-&gt;a_lnotab);</span>
</span><span class='line'><span class="gd">-    if (!bytecode)</span>
</span><span class='line'><span class="gd">-        goto error;</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'>     tmp = PyList_AsTuple(consts); /* PyCode_New requires a tuple */
</span><span class='line'>     if (!tmp)
</span><span class='line'>         goto error;
</span><span class='line'><span class="gu">@@ -4270,7 +4266,7 @@</span>
</span><span class='line'>     kwonlyargcount = Py_SAFE_DOWNCAST(c-&gt;u-&gt;u_kwonlyargcount, Py_ssize_t, int);
</span><span class='line'>     co = PyCode_New(argcount, kwonlyargcount,
</span><span class='line'>                     nlocals_int, stackdepth(c), flags,
</span><span class='line'><span class="gd">-                    bytecode, consts, names, varnames,</span>
</span><span class='line'><span class="gi">+                    a-&gt;a_bytecode, consts, names, varnames,</span>
</span><span class='line'>                     freevars, cellvars,
</span><span class='line'>                     c-&gt;c_filename, c-&gt;u-&gt;u_name,
</span><span class='line'>                     c-&gt;u-&gt;u_firstlineno,
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">continuer</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">8</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">DUP_TOP</span>
</span><span class='line'>              <span class="mi">4</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">7</span> <span class="n">DUP_TOP</span>
</span><span class='line'>              <span class="mi">8</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">11</span> <span class="n">STORE_FAST</span>               <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">9</span>          <span class="mi">14</span> <span class="n">SETUP_LOOP</span>              <span class="mi">79</span> <span class="p">(</span><span class="n">to</span> <span class="mi">96</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">17</span> <span class="n">LOAD_GLOBAL</span>              <span class="mi">0</span> <span class="p">(</span><span class="nb">range</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">20</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">23</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">1</span> <span class="p">(</span><span class="mi">1</span> <span class="n">positional</span><span class="p">,</span> <span class="mi">0</span> <span class="n">keyword</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">26</span> <span class="n">GET_ITER</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span>   <span class="mi">27</span> <span class="n">FOR_ITER</span>                <span class="mi">65</span> <span class="p">(</span><span class="n">to</span> <span class="mi">95</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">30</span> <span class="n">STORE_FAST</span>               <span class="mi">3</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">10</span>         <span class="mi">33</span> <span class="n">LOAD_FAST</span>                <span class="mi">3</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">36</span> <span class="n">LOAD_CONST</span>               <span class="mi">3</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">39</span> <span class="n">BINARY_MODULO</span>
</span><span class='line'>             <span class="mi">40</span> <span class="n">POP_JUMP_IF_FALSE</span>       <span class="mi">72</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">11</span>         <span class="mi">43</span> <span class="n">LOAD_FAST</span>                <span class="mi">3</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">46</span> <span class="n">LOAD_CONST</span>               <span class="mi">4</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">49</span> <span class="n">BINARY_MODULO</span>
</span><span class='line'>             <span class="mi">50</span> <span class="n">POP_JUMP_IF_FALSE</span>       <span class="mi">66</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">12</span>         <span class="mi">53</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">56</span> <span class="n">LOAD_CONST</span>               <span class="mi">5</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">59</span> <span class="n">INPLACE_ADD</span>
</span><span class='line'>             <span class="mi">60</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">63</span> <span class="n">JUMP_FORWARD</span>             <span class="mi">0</span> <span class="p">(</span><span class="n">to</span> <span class="mi">66</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">13</span>    <span class="o">&gt;&gt;</span>   <span class="mi">66</span> <span class="n">JUMP_ABSOLUTE</span>           <span class="mi">27</span>
</span><span class='line'>             <span class="mi">69</span> <span class="n">JUMP_FORWARD</span>            <span class="mi">10</span> <span class="p">(</span><span class="n">to</span> <span class="mi">82</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">14</span>    <span class="o">&gt;&gt;</span>   <span class="mi">72</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">75</span> <span class="n">LOAD_CONST</span>               <span class="mi">5</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">78</span> <span class="n">INPLACE_ADD</span>
</span><span class='line'>             <span class="mi">79</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">15</span>    <span class="o">&gt;&gt;</span>   <span class="mi">82</span> <span class="n">LOAD_FAST</span>                <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">85</span> <span class="n">LOAD_CONST</span>               <span class="mi">5</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">88</span> <span class="n">INPLACE_ADD</span>
</span><span class='line'>             <span class="mi">89</span> <span class="n">STORE_FAST</span>               <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">92</span> <span class="n">JUMP_ABSOLUTE</span>           <span class="mi">27</span>
</span><span class='line'>        <span class="o">&gt;&gt;</span>   <span class="mi">95</span> <span class="n">POP_BLOCK</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">16</span>    <span class="o">&gt;&gt;</span>   <span class="mi">96</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">99</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>            <span class="mi">102</span> <span class="n">LOAD_FAST</span>                <span class="mi">2</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>            <span class="mi">105</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">3</span>
</span><span class='line'>            <span class="mi">108</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just as we expected, the jump targets have changed. The instruction at position 50, <code>POP_JUMP_IF_FALSE</code>, now has 66 as its jump target &ndash; a previously unreachable instruction associated with the <code>continue</code>. Instruction 63, <code>JUMP_FORWARD</code>, is also targeting 66. In both cases, the only way to reach this instruction is to jump to it, and the instruction itself jumps away.<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup></p>

<p>Now we can run our coverage tool with the unoptimized Python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>peephole [master *+] ⚲ ../cpython/python.exe coverage2.py
</span><span class='line'>100% coverage, go you!
</span></code></pre></td></tr></table></div></figure>


<p>Complete success!</p>

<h2>So is this a good idea or not?</h2>

<p>Compiler optimizations are often a straightforward win.  If the compiler can apply simple rules that make my code faster without requiring work from me, that&rsquo;s great. Almost nobody requires a strict mapping of code that they write to code that ends up executing. So, peephole optimization in general: yes! Great!</p>

<p>But &ldquo;almost nobody&rdquo; is not nobody, and one kind of people who <em>do</em> require strict reasoning about executed code are the authors of test coverage software. In the <a href="//mail.python.org/pipermail/python-ideas/2014-May/027893.html">python-dev thread</a> I linked to earlier, there was an extensive discussion over whether or not serving this demographic by providing an option to disable to optimizations was worth increasing the complexity of the codebase. Ultimately it was decided that it was worthwhile, but this is a fair question to ask.</p>

<h2>Further reading</h2>

<p>Beyond the interesting Python-dev thread linked above, my other suggestions are mostly code. <a href="//hg.python.org/cpython/file/118d6f49d6d6/Python/peephole.c">CPython&rsquo;s <code>peephole.c</code></a> is pretty readable C code, and I encourage you to take a look at it. (&ldquo;Constant folding&rdquo; is a great place to start.) There&rsquo;s also a website <a href="//www.compileroptimizations.com/">compileroptimizations.com</a> which has short examples and discussion of 45 different optimizations. If you&rsquo;d like to play with these code examples, they&rsquo;re all available on my <a href="//github.com/akaptur/peephole-optimization">github</a>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>We need to include <code>call</code> events to capture the first line of a function declaration, <code>def fn(...):</code><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>I&rsquo;ve previously written an introduction to the disassembler <a href="/blog/2013/11/17/introduction-to-the-python-interpreter-3/">here</a>.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>You may be wondering what the <code>JUMP_ABSOLUTE</code> instruction at position 66 is doing.  This instruction does nothing unless a particular compiler optimization is turned on. The optimization support faster loops, but creates restrictions on what those loops can do. See <code>ceval.c</code> for more. <em>Edit: This footnote previously incorrectly referenced <code>JUMP_FORWARD</code>.</em><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/11/of-syntax-warnings-and-symbol-tables/">Of Syntax Warnings and Symbol Tables</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-11T18:30:00-04:00" pubdate data-updated="true">Jun 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A Hacker Schooler hit an interesting bug today: her program would sometimes emit the message <code>SyntaxWarning: import * only allowed at module level</code>.  I had never seen a <code>SyntaxWarning</code> before, so I decided to dig in.</p>

<p>The wording of the warning is strange: it says that star-import is only <em>allowed</em> at the module level, but it&rsquo;s not a syntax error, just a warning.  In fact, you can use a star-import in a scope that isn&rsquo;t a module (in Python 2):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">nope</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">stdin</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="ne">SyntaxWarning</span><span class="p">:</span> <span class="kn">import</span> <span class="o">*</span> <span class="n">only</span> <span class="n">allowed</span> <span class="n">at</span> <span class="n">module</span> <span class="n">level</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">nope</span><span class="p">()</span>
</span><span class='line'><span class="mi">7</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Python <a href="https://docs.python.org/2/reference/simple_stmts.html?highlight=import#the-import-statement">spec</a> gives some more details:</p>

<blockquote><p>The from form with * may only occur in a module scope. If the wild card form of import — import * — is used in a function and the function contains or is a nested block with free variables, the compiler will raise a SyntaxError.</p></blockquote>

<p>Just having <code>import *</code> in a function isn&rsquo;t enough to raise a syntax error &ndash; we also need free variables. The <a href="https://docs.python.org/2.7/reference/executionmodel.html">Python execution model</a> refers to three kinds of variables, &lsquo;local,&rsquo; &lsquo;global,&rsquo; and &lsquo;free&rsquo;, defined as follows:</p>

<blockquote><p>If a name is bound in a block, it is a local variable of that block. If a name is bound at the module level, it is a global variable. (The variables of the module code block are local and global.) If a variable is used in a code block but not defined there, it is a free variable.</p></blockquote>

<p>Now we can see how to trigger a syntax error from our syntax warning:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>         <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="o">...</span>         <span class="k">print</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="n">two</span><span class="p">()</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">stdin</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span> <span class="ne">SyntaxWarning</span><span class="p">:</span> <span class="kn">import</span> <span class="o">*</span> <span class="n">only</span> <span class="n">allowed</span> <span class="n">at</span> <span class="n">module</span> <span class="n">level</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span>
</span><span class='line'><span class="ne">SyntaxError</span><span class="p">:</span> <span class="kn">import</span> <span class="o">*</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="ow">in</span> <span class="n">function</span> <span class="s">&#39;two&#39;</span> <span class="n">because</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">nested</span> <span class="n">function</span>
</span></code></pre></td></tr></table></div></figure>


<p>and similarly,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="o">...</span>     <span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>         <span class="k">print</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="n">two</span><span class="p">()</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">stdin</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="ne">SyntaxWarning</span><span class="p">:</span> <span class="kn">import</span> <span class="o">*</span> <span class="n">only</span> <span class="n">allowed</span> <span class="n">at</span> <span class="n">module</span> <span class="n">level</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span>
</span><span class='line'><span class="ne">SyntaxError</span><span class="p">:</span> <span class="kn">import</span> <span class="o">*</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="ow">in</span> <span class="n">function</span> <span class="s">&#39;one&#39;</span> <span class="n">because</span> <span class="n">it</span> <span class="n">contains</span> <span class="n">a</span> <span class="n">nested</span> <span class="n">function</span> <span class="k">with</span> <span class="n">free</span> <span class="n">variables</span>
</span></code></pre></td></tr></table></div></figure>


<p>As Python programmers, we&rsquo;re used to our lovely dynamic language, and it&rsquo;s unusual to hit compile-time constraints.  As <a href="https://twitter.com/amygdalama">Amy Hanlon</a> points out, it&rsquo;s particularly weird to hit a compile-time error for code that wouldn&rsquo;t raise a NameError when it ran &ndash; <code>randint</code> would indeed be in <code>one</code>&rsquo;s namespace if the import-star had executed.</p>

<p>But we can&rsquo;t run code that doesn&rsquo;t compile, and in this case the compiler doesn&rsquo;t have enough information to determine what bytecode to emit. There are different opcodes for loading and storing each of global, free, and local variables. A variable&rsquo;s status as global, free, or local must be determined at compile time and then stored in the symbol table.</p>

<p>To investigate this, let&rsquo;s look at minor variations on this code snippet and disassemble them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">code_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">((</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">__code__</span><span class="p">)</span> <span class="c"># just a handle on the code type, which isn&#39;t exposed as a builtin</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="c"># A helper function to disassemble nested functions</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">recur_dis</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">__code__</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">fn</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">const</span><span class="p">,</span> <span class="n">code_type</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>             <span class="k">print</span>
</span><span class='line'><span class="o">...</span>             <span class="k">print</span>
</span><span class='line'><span class="o">...</span>             <span class="k">print</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>             <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, when <code>x</code> is local, the compiler emits <code>STORE_FAST</code> in the assignment statement and <code>LOAD_FAST</code> to load it, marked with arrows below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>         <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="o">...</span>         <span class="k">print</span> <span class="n">x</span>
</span><span class='line'><span class="o">...</span>     <span class="n">two</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">recur_dis</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">one</span> <span class="n">at</span> <span class="mh">0x10e246730</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">two</span> <span class="n">at</span> <span class="mh">0x10e246030</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">MAKE_FUNCTION</span>            <span class="mi">0</span>
</span><span class='line'>              <span class="mi">6</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">5</span>           <span class="mi">9</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">12</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">0</span>
</span><span class='line'>             <span class="mi">15</span> <span class="n">POP_TOP</span>
</span><span class='line'>             <span class="mi">16</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">19</span> <span class="n">RETURN_VALUE</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">two</span> <span class="n">at</span> <span class="mh">0x10e246030</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="mi">3</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>          <span class="o">&lt;----</span> <span class="n">STORE_FAST</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">4</span>           <span class="mi">6</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>          <span class="o">&lt;-----</span> <span class="n">LOAD_FAST</span>
</span><span class='line'>              <span class="mi">9</span> <span class="n">PRINT_ITEM</span>
</span><span class='line'>             <span class="mi">10</span> <span class="n">PRINT_NEWLINE</span>
</span><span class='line'>             <span class="mi">11</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">14</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>When <code>x</code> is global, the compiler emits <code>LOAD_GLOBAL</code> to load it.  I think the assignment is <code>STORE_FAST</code> again, but it&rsquo;s not pictured here because the assignment is outside the function and thus not disassembled.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>         <span class="k">print</span> <span class="n">x</span>
</span><span class='line'><span class="o">...</span>     <span class="n">two</span><span class="p">()</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">recur_dis</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">one</span> <span class="n">at</span> <span class="mh">0x10e246730</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">two</span> <span class="n">at</span> <span class="mh">0x10e2464b0</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">MAKE_FUNCTION</span>            <span class="mi">0</span>
</span><span class='line'>              <span class="mi">6</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">4</span>           <span class="mi">9</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">12</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">0</span>
</span><span class='line'>             <span class="mi">15</span> <span class="n">POP_TOP</span>
</span><span class='line'>             <span class="mi">16</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">19</span> <span class="n">RETURN_VALUE</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">two</span> <span class="n">at</span> <span class="mh">0x10e2464b0</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="mi">3</span>           <span class="mi">0</span> <span class="n">LOAD_GLOBAL</span>              <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>          <span class="o">&lt;-----</span> <span class="n">LOAD_GLOBAL</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">PRINT_ITEM</span>
</span><span class='line'>              <span class="mi">4</span> <span class="n">PRINT_NEWLINE</span>
</span><span class='line'>              <span class="mi">5</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">8</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, when <code>x</code> is nonlocal, the compiler notices that we&rsquo;ll need a closure, and emits the opcodes <code>LOAD_CLOSURE</code>, <code>MAKE_CLOSURE</code>, and later <code>LOAD_DEREF</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="o">...</span>     <span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>        <span class="k">print</span> <span class="n">x</span>
</span><span class='line'><span class="o">...</span>     <span class="n">two</span><span class="p">()</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">recur_dis</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">one</span> <span class="n">at</span> <span class="mh">0x10e246e30</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">STORE_DEREF</span>              <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>          <span class="o">&lt;-----</span> <span class="n">STORE_DEREF</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">3</span>           <span class="mi">6</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>          <span class="o">&lt;-----</span> <span class="n">LOAD_CLOSURE</span>
</span><span class='line'>              <span class="mi">9</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">1</span>
</span><span class='line'>             <span class="mi">12</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">two</span> <span class="n">at</span> <span class="mh">0x10e246d30</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">15</span> <span class="n">MAKE_CLOSURE</span>             <span class="mi">0</span>
</span><span class='line'>             <span class="mi">18</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">5</span>          <span class="mi">21</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">two</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">24</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">0</span>
</span><span class='line'>             <span class="mi">27</span> <span class="n">POP_TOP</span>
</span><span class='line'>             <span class="mi">28</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">31</span> <span class="n">RETURN_VALUE</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">two</span> <span class="n">at</span> <span class="mh">0x10e246d30</span><span class="p">,</span> <span class="nb">file</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="mi">4</span>           <span class="mi">0</span> <span class="n">LOAD_DEREF</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>          <span class="o">&lt;-----</span> <span class="n">LOAD_DEREF</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">PRINT_ITEM</span>
</span><span class='line'>              <span class="mi">4</span> <span class="n">PRINT_NEWLINE</span>
</span><span class='line'>              <span class="mi">5</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">8</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s now return to a case that throws a syntax error.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>      <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="o">...</span>      <span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>          <span class="k">print</span> <span class="n">x</span>
</span><span class='line'><span class="o">...</span>      <span class="n">two</span><span class="p">()</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">stdin</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="ne">SyntaxWarning</span><span class="p">:</span> <span class="kn">import</span> <span class="o">*</span> <span class="n">only</span> <span class="n">allowed</span> <span class="n">at</span> <span class="n">module</span> <span class="n">level</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span>
</span><span class='line'><span class="ne">SyntaxError</span><span class="p">:</span> <span class="kn">import</span> <span class="o">*</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="ow">in</span> <span class="n">function</span> <span class="s">&#39;one&#39;</span> <span class="n">because</span> <span class="n">it</span> <span class="n">contains</span> <span class="n">a</span> <span class="n">nested</span> <span class="n">function</span> <span class="k">with</span> <span class="n">free</span> <span class="n">variables</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;d love to show what the disassembled bytecode for this one looks like, but we can&rsquo;t do that because there is no bytecode! We got a compile-time error, so there&rsquo;s nothing here.</p>

<h3>Further reading</h3>

<p>Everything I know about symbol tables I learned from <a href="http://eli.thegreenplace.net/2010/09/18/python-internals-symbol-tables-part-1/">Eli Bendersky&rsquo;s blog</a>. I&rsquo;ve skipped some complexity in the implementation that Eli covers.</p>

<p><code>ack</code>ing through the source code of CPython for the text of the error message leads us right to <code>symtable.c</code>, which is exactly where we&rsquo;d expect this message to be emitted. The function <code>check_unoptimized</code> shows where the syntax error gets thrown (and shows another illegal construct, too &ndash; but we&rsquo;ll leave that one as an exercise for the reader).</p>

<p>p.s. In Python 3, <code>import *</code> anywhere other than a module is just an unqualified syntax error &ndash; none of this messing around with the symbol table.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/16/pycon-prep-import-is-a-keyword/">PyCon Prep: Import Is a Keyword</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-16T16:08:00-04:00" pubdate data-updated="true">Mar 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week I had a ton of fun working with <a href="https://twitter.com/amygdalama">Amy Hanlon</a> on her Harry Potter themed fork of Python, called Nagini.  Nagini is full of magic and surprises. It implements the things you&rsquo;d hope for out of a Harry Potter Python, like making <code>quit</code> into <code>avada_kedavra</code>, and many analogous jokes.</p>

<p>Amy also had the idea to replace <code>import</code> with <code>accio</code>! Replacing <code>import</code> is a much harder problem than renaming a builtin.  Python doesn&rsquo;t prevent you from overwriting builtins, whereas to change keywords you have to edit the grammar and recompile Python. You should <a href="http://mathamy.com/import-accio-bootstrapping-python-grammar.html">go read Amy&rsquo;s post</a> on making this work.</p>

<p>This brings us to an interesting question: why <em>is</em> <code>import</code> a keyword, anyway? There&rsquo;s a function, <code>__import__</code>, that does (mostly) the same thing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;random&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">module</span> <span class="s">&#39;random&#39;</span> <span class="kn">from</span> <span class="s">&#39;/path/to/random.pyc&#39;</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function form requires the programmer to assign the return value &ndash; the module &ndash; to a name, but once we&rsquo;ve done that it works just like a normal module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">random</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;random&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
</span><span class='line'><span class="mf">0.32574174955668145</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>__import__</code> function can handle all the forms of import, including <code>from foo import bar</code> and <code>from baz import *</code> (although it never modifies the calling namespace).  There&rsquo;s no technical reason why <code>__import__</code> couldn&rsquo;t be the regular way to do imports.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>As far as I can tell, the main argument against an <code>import</code> function is aesthetic. Compare:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">foo</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">foo</span> <span class="kn">import</span> <span class="n">bar</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">longmodulename</span> <span class="kn">as</span> <span class="nn">short</span>
</span><span class='line'>
</span><span class='line'><span class="n">foo</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">bar</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;random&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bar</span>
</span><span class='line'><span class="n">short</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;longmodulename&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first way certainly feels much cleaner and more readable.<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<p>Part of my goal in my <a href="https://us.pycon.org/2014/schedule/presentation/229/">upcoming PyCon talk</a> is to invite Pythonistas to consider decisions they might not have thought about before. <code>import</code> is a great vehicle for this, because everyone learns it very early on in their programming development, but most people don&rsquo;t ever think about it again. Here&rsquo;s another variation on that theme: <code>import</code> doesn&rsquo;t have to be a keyword!</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>I think all keywords <em>could</em> be expressed as functions, except those used for flow control (which I loosely define as keywords that generate any <code>JUMP</code> instructions when compiled). For example, between Python 2 and 3, two keywords did become functions &ndash; <code>print</code> and <code>exec</code>.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>I realize this is a slightly circular argument &ndash; if the function strategy were the regular way to import, it probably wouldn&rsquo;t be so ugly.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/16/reading-ebnf/">Reading EBNF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-16T15:39:00-04:00" pubdate data-updated="true">Mar 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the fun parts of <a href="http://mathamy.com/import-accio-bootstrapping-python-grammar.html">pairing with Amy on Nagini</a> was modifying the grammar of Python. You should try this &ndash; it&rsquo;s easier than you think! Eli Bendersky has a <a href="eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/">great post</a> with step-by-step instructions.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>Modifying Python&rsquo;s grammar starts in the Grammar/Grammar file. I&rsquo;ve recently learned how to read this (which, for me, mostly means learning how to pronounce the punctuation), so I want to walk through the <code>import</code> example in some detail. The syntax here is <a href="http://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_Form">Extended Backus-Naur Form</a>, or EBNF. You read it like a tree, and your primary verb is &ldquo;consists of&rdquo;:</p>

<ul>
<li><code>import_stmt</code> consists of one of two forms, <code>import_name</code> or <code>import_from</code>.</li>
<li><code>import_name</code> consists of the literal word <code>import</code> followed by <code>dotted_as_names</code>.</li>
<li><code>dotted_as_names</code> consists of a <code>dotted_as_name</code> (note the singular), optionally followed by one or more pairs of a comma and another <code>dotted_as_name</code>.</li>
<li><code>dotted_as_name</code> consists of a <code>dotted_name</code>, optionally followed by the literal word &lsquo;as&rsquo; and a NAME.</li>
<li>Finally, <code>dotted_name</code> consists of a <code>NAME</code>, maybe followed by pairs of a dot and another <code>NAME</code>.</li>
</ul>


<p>You can walk the other branches in a similar way.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import_stmt: import_name | import_from
</span><span class='line'>import_name: 'import' dotted_as_names
</span><span class='line'># note below: the ('.' | '...') is necessary because '...' is tokenized as ELLIPSIS
</span><span class='line'>import_from: ('from' (('.' | '...')* dotted_name | ('.' | '...')+)
</span><span class='line'>              'import' ('*' | '(' import_as_names ')' | import_as_names))
</span><span class='line'>import_as_name: NAME ['as' NAME]
</span><span class='line'>dotted_as_name: dotted_name ['as' NAME]
</span><span class='line'>import_as_names: import_as_name (',' import_as_name)* [',']
</span><span class='line'>dotted_as_names: dotted_as_name (',' dotted_as_name)*
</span><span class='line'>dotted_name: NAME ('.' NAME)*</span></code></pre></td></tr></table></div></figure>


<p>To <code>accio</code>-ify Python, we had to replace the occurences of <code>'import'</code> with <code>'accio'</code>. There are only two &ndash; we were only interested in the literal string <code>import</code>, not all the other names. <code>import_as_name</code> and so on are just nodes in the tree, and only matter to the parser and compiler.</p>

<p>Every other keyword and symbol that has special meaning to the Python parser also appears in Grammar as a string.</p>

<p>Perusing the grammar is (goofy) way to learn about corner cases of Python syntax, too!  For example, did you know that <code>with</code> can take more than one context manager? It&rsquo;s right there in the grammar:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>with_stmt: 'with' with_item (',' with_item)*  ':' suite
</span><span class='line'>with_item: test ['as' expr]</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;foo.txt&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;bar.txt&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">closed</span> <span class="nb">file</span> <span class="s">&#39;foo.txt&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="s">&#39;w&#39;</span> <span class="n">at</span> <span class="mh">0x10bf71270</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">g</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">closed</span> <span class="nb">file</span> <span class="s">&#39;bar.txt&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="s">&#39;w&#39;</span> <span class="n">at</span> <span class="mh">0x10bf71810</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now go ahead and add your favorite keyword into Python!</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Like Eli, I&rsquo;m not advocating for Python&rsquo;s actual grammar to change &ndash; it&rsquo;s just a fun exercise.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/16/pycon-prep-require-in-ruby/">PyCon Prep: `require` in Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-16T14:18:00-05:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m talking about <code>import</code> at PyCon in April. In the talk, we&rsquo;ll imagine that there is no <code>import</code> and will reinvent it from scratch. I hope this will give everyone (including me!) a deeper understanding of the choices <code>import</code> makes and the ways it could have been different. Ideally, the structure will be a couple of sections of the form &ldquo;We could have made [decisions].  That would mean [effects].  Surprise &ndash; that&rsquo;s how it works in [language]!&rdquo;<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>This is the first of (probably) several posts with notes of things I&rsquo;m learning as I prepare my talk.  Feedback is welcome.</p>

<p>Today I&rsquo;m looking into Ruby&rsquo;s <code>require</code> and <code>require_relative</code><sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> to see if aspects of them would be interesting to Python programmers. So far, here&rsquo;s what I think is most relevant:</p>

<ul>
<li><p>Unlike Python, <code>require</code> won&rsquo;t load all objects in the required file. There&rsquo;s a concept of local versus global variables in the file scope that doesn&rsquo;t exist in Python.</p></li>
<li><p>Unlike Python, one file does not map to one module. Modules are created by using the keyword <code>module</code>.</p></li>
<li><p>Unlike Python, namespace collisions are completely possible. Consider the following simple files:</p></li>
</ul>


<figure class='code'><figcaption><span>one.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">puts</span> <span class="s2">&quot;one!&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>  <span class="ss">:hello</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>two.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">puts</span> <span class="s2">&quot;two!&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>  <span class="ss">:world</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>main.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;one&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;two&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">foo</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the output from running <code>main.rb</code>:</p>

<figure class='code'><figcaption><span>output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">one!</span>
</span><span class='line'><span class="n">two!</span>
</span><span class='line'><span class="n">world</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Like Python&rsquo;s <code>import</code>, <code>require</code> will only load a file once. This can interact interestingly with namespace collisions &ndash; to take a contrived example:</li>
</ul>


<figure class='code'><figcaption><span>main.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;one&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;two&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;one&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">foo</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because <code>one.rb</code> isn&rsquo;t reloaded, <code>foo</code> is still <code>'world'</code>:</p>

<figure class='code'><figcaption><span>output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">one!</span>
</span><span class='line'><span class="n">two!</span>
</span><span class='line'><span class="n">world</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Questions for further investigation / thought</h3>

<p>My talk should <em>not</em> convince people that Python is Right and other languages are Wrong.  I&rsquo;m trying to overcome my bias towards the system I&rsquo;m most used to. (I think I&rsquo;ve written roughly equal amounts of Python and Ruby, but the vast majority of the Ruby I&rsquo;ve written is Rails, where all the <code>require</code>ing and namespacing happens by magic.) Here are some questions I&rsquo;d like to research more.</p>

<ol>
<li><p>Python&rsquo;s namespacing feels much better to me, although I&rsquo;m sure that&rsquo;s partly because I&rsquo;m used to it. What&rsquo;s the advantage to doing namespacing this way?</p></li>
<li><p>Why have both <code>require</code> and <code>require_relative</code>? Why not have <code>require</code> check the relative path as well before raising a <code>LoadError</code>?</p></li>
<li><p>What&rsquo;s the advantage of uncoupling a module from a file?</p></li>
</ol>

<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>I <a href="https://twitter.com/akaptur/status/433281929199095809">asked on twitter</a> for suggestions of languages that make interesting decisions about <code>import</code> equivalents. So far the suggestions are R, Go, Rust, Ruby, JavaScript, and Clojure. If you have others, let me know.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>As far as I can tell, the only difference between <code>require</code> and <code>require_relative</code> is the load path searched.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/03/introduction-to-the-python-interpreter-4/">Introduction to the Python Interpreter, Part 4: It&#8217;s Dynamic!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-03T11:25:00-05:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This is Part 4 in a <a href="/blog/categories/python-internals">series</a> on the Python interpreter. Read <a href="/blog/2013/11/15/introduction-to-the-python-interpreter/">Part 1</a>, <a href="/blog/2013/11/15/introduction-to-the-python-interpreter-2/">Part 2</a>, and <a href="/blog/2013/11/17/introduction-to-the-python-interpreter-3/">Part 3</a>. If you&rsquo;re enjoying this series, consider applying to <a href="https://www.hackerschool.com/">Hacker School</a>, where I work as a facilitator.</em></p>

<p>One of the things I was confused about when I started digging into python internals was how python could be &ldquo;dynamic&rdquo; if it was also &ldquo;compiled.&rdquo; Often, in casual coversation, those two words are used as antonyms &ndash; there are &ldquo;dynamic languages,&rdquo;<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> like Python, Ruby, and Javascript, and &ldquo;compiled languages,&rdquo; like C, Java, and Haskell.</p>

<p>Most of the time, when people talk about a &ldquo;compiled&rdquo; language, they mean one that compiles down to native x86/ARM/etc instructions<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> &ndash; instructions for an actual machine made of metal. An &ldquo;interpreted&rdquo; language either doesn&rsquo;t have any compilation at all<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>, or compiles to an intermediate representation, like bytecode.  Bytecode is instructions for a virtual machine, not a piece of hardware. Python falls into this latter category: the Python compiler&rsquo;s job is to generate bytecode for the Python interpreter.<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup></p>

<p>The Python interpreter&rsquo;s job is to make sense of the bytecode via the virtual machine, which turns out to be a lot of work. We&rsquo;ll dig in to the virtual machine in Part 5.</p>

<p>So far our discussion of compiling versus interpretation has been abstract. These ideas become more clear with an example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">modulus</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">%</span> <span class="n">y</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">modulus</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_code</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">83</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">modulus</span><span class="o">.</span><span class="n">func_code</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">6</span> <span class="n">BINARY_MODULO</span>
</span><span class='line'>              <span class="mi">7</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s a function, its bytecode, and its bytecode run through the disassembler. By the time we get the prompt back after the function definition, the <code>modulus</code> function has been compiled and a code object generated. That code object will never be modified.</p>

<p>This seems pretty easy to reason about. Unsurprisingly, typing a modulus (<code>%</code>) causes the compiler to emit the instruction <code>BINARY_MODULO</code>. It looks like this function will be useful if we need to calculate a remainder.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">modulus</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>So far, so good. But what if we don&rsquo;t pass it numbers?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">modulus</span><span class="p">(</span><span class="s">&quot;hello </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">)</span>
</span><span class='line'><span class="s">&#39;hello world&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Uh-oh, what happened there? You&rsquo;ve probably seen this before, but it usually looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="s">&quot;hello </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;world&quot;</span>
</span><span class='line'><span class="n">hello</span> <span class="n">world</span>
</span></code></pre></td></tr></table></div></figure>


<p>Somehow, when <code>BINARY_MODULO</code> is faced with two strings, it does string interpolation instead of taking a remainder. This situation is a great example of dynamic typing. When the compiler built our code object for <code>modulus</code>, it had no idea whether <code>x</code> and <code>y</code> would be strings, numbers, or something else entirely. It just emitted some instructions: load one name, load another, <code>BINARY_MODULO</code> the two objects, and return the result. It&rsquo;s the interpreter&rsquo;s job to figure out what <code>BINARY_MODULO</code> actually means.</p>

<p>I&rsquo;d like to reflect on the depth of our ignorance for a moment. Our function <code>modulus</code> can calculate remainders, or it can do string formatting &hellip; what else?  If we define a custom object that responds to <code>__mod__</code>, then we can do <em>anything</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Surprise</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>         <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>
</span><span class='line'><span class="o">...</span>     <span class="k">def</span> <span class="nf">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">num</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">seven</span> <span class="o">=</span> <span class="n">Surprise</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">four</span> <span class="o">=</span> <span class="n">Surprise</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">modulus</span><span class="p">(</span><span class="n">seven</span><span class="p">,</span> <span class="n">four</span><span class="p">)</span>
</span><span class='line'><span class="mi">11</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">modulus</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="mi">3</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">modulus</span><span class="p">(</span><span class="s">&quot;hello </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">)</span>
</span><span class='line'><span class="s">&#39;hello world&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The same function <code>modulus</code>, with the same bytecode, has wildly different effects when passed different kinds of objects.  It&rsquo;s also possible for <code>modulus</code> to raise an error &ndash; for example, a <code>TypeError</code> if we called it on objects that didn&rsquo;t implement <code>__mod__</code>. Heck, we could even write a custom object that raises a <code>SystemExit</code> when <code>__mod__</code> is invoked.  Our <code>__mod__</code> function could have written to a file, or changed a global variable, or deleted another attribute of the object. We have near-total freedom.</p>

<p>This ignorance is one of the reasons that it&rsquo;s hard to optimize Python: you don&rsquo;t know when you&rsquo;re compiling the code object and generating the bytecode what it&rsquo;s going to end up doing. The compiler has no idea what&rsquo;s going to happen. As Russell Power and Alex Rubinsteyn wrote in <a href="http://arxiv.org/pdf/1306.6047v2.pdf">&ldquo;How fast can we make interpreted Python?&rdquo;</a>, &ldquo;In the general absence of type information, almost every instruction must be treated as INVOKE_ARBITRARY_METHOD.&rdquo;</p>

<p>While a general definition of &ldquo;compiling&rdquo; and &ldquo;interpreting&rdquo; can be difficult to nail down, in the context of Python it&rsquo;s fairly straightforward. Compiling is generating the code objects, including the bytecode. Interpreting is making sense of the bytecode in order to actually make things happen. One of the ways in which Python is &ldquo;dynamic&rdquo; is that the same bytecode doesn&rsquo;t always have the same effect. More generally, in Python the compiler does relatively little work, and the intrepreter relatively more.</p>

<p>In Part 5, we&rsquo;ll look at the actual virtual machine and interpreter.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>You sometimes hear &ldquo;interpreted language&rdquo; instead of &ldquo;dynamic language,&rdquo; which is usually, mostly, synonymous.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>Thanks to David Nolen for this definition. The lines between &ldquo;parsing,&rdquo; &ldquo;compiling,&rdquo; and &ldquo;interpreting&rdquo; are not always clear. <a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>Some languages that are usually not compiled at all include R, Scheme, and binary, depending on the implementation and your definition of &ldquo;compile.&rdquo;<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p>As always in this series, I&rsquo;m talking about CPython and Python 2.7, although most of this content is true across implementations.<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/17/introduction-to-the-python-interpreter-3/">Introduction to the Python Interpreter, Part 3: Understanding Bytecode</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-17T09:56:00-05:00" pubdate data-updated="true">Nov 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This is Part 3 in a series on the Python interpreter.  Part 1 <a href="/blog/2013/11/15/introduction-to-the-python-interpreter/">here</a>, Part 2 <a href="/blog/2013/11/15/introduction-to-the-python-interpreter-2/">here</a>.  If you&rsquo;re enjoying this series, consider applying to <a href="https://www.hackerschool.com/">Hacker School</a>, where I work as a facilitator.</em></p>

<h3>Bytecode</h3>

<p>When we left our heroes, they had come across some odd-looking output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_code</span>
</span><span class='line'><span class="s">&#39;d</span><span class="se">\x01\x00</span><span class="s">}</span><span class="se">\x01\x00</span><span class="s">|</span><span class="se">\x01\x00</span><span class="s">|</span><span class="se">\x00\x00\x17</span><span class="s">S&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is python <em>bytecode</em>.</p>

<p>You recall from Part 2 that &ldquo;python bytecode&rdquo; and &ldquo;a python code object&rdquo; are not the same thing: the bytecode is an attribute of the code object, among many other attributes.  Bytecode is found in the <code>co_code</code> attribute of the code object, and contains instructions for the interpreter.</p>

<p>So what is bytecode?  Well, it&rsquo;s just a series of bytes.  They look wacky when we print them because some bytes are printable and others aren&rsquo;t, so let&rsquo;s take the <code>ord</code> of each byte to see that they&rsquo;re just numbers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">foo</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_code</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">83</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are the bytes that make up python bytecode.  The interpreter will loop through each byte, look up what it should do for each one, and then do that thing.  Notice that the bytecode itself doesn&rsquo;t include any python objects, or references to objects, or anything like that.</p>

<p>One way to understand python bytecode would be to find the CPython interpreter file (it&rsquo;s <code>ceval.c</code>), and flip through it looking up what <code>100</code> means, then <code>1</code>, then <code>0</code>, and so on.  We&rsquo;ll do this later in the series!  For now, there&rsquo;s a simpler way: the <code>dis</code> module.</p>

<h3>Disassembling bytecode</h3>

<p>Disassembling bytecode means taking this series of bytes and printing out something we humans can understand.  It&rsquo;s not a step in python execution; the <code>dis</code> module just helps us understand an intermediate state of python internals. I can&rsquo;t think of a reason why you&rsquo;d ever want to use <code>dis</code> in production code &ndash; it&rsquo;s for humans, not for machines.</p>

<p>Today, however, taking some bytecode and making it human-readable is exactly what we&rsquo;re trying to do, so <code>dis</code> is a great tool.  We&rsquo;ll use the function <code>dis.dis</code> to analyze the code object of our function <code>foo</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'><span class="o">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">a</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">dis</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">func_code</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">3</span>           <span class="mi">6</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">9</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">12</span> <span class="n">BINARY_ADD</span>
</span><span class='line'>             <span class="mi">13</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>(You usually see this called as <code>dis.dis(foo)</code>, directly on the function object.  That&rsquo;s just a convenience: <code>dis</code> is really analyzing the code object.  If it&rsquo;s passed a function, it just gets its code object.)</p>

<p>The numbers in the left-hand column are line numbers in the original source code.  The second column is the offset into the bytecode: <code>LOAD_CONST</code> appears at position 0, <code>STORE_FAST</code> at position 3, and so on.  The middle column shows the names of bytes. These names are just for our (human) benefit &ndash; the interpreter doesn&rsquo;t need the names.</p>

<p>The last two columns give details about the instructions&rsquo;s argument, if there is an argument.  The fourth column shows the argument itself, which represents an index into other attributes of the code object. In the example, <code>LOAD_CONST</code>&rsquo;s argument is an index into the list <code>co_consts</code>, and <code>STORE_FAST</code>&rsquo;s argument is an index into <code>co_varnames</code>.  Finally, in the fifth column, <code>dis</code> has looked up the constants or names in the place the fourth column specified and told us what it found there. We can easily verify this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_consts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'><span class="mi">3</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'><span class="s">&#39;x&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This also explains why the second instruction, <code>STORE_FAST</code>, is found at bytecode position 3.  If a bytecode has an argument, the next two bytes are that argument. It&rsquo;s the interpreter&rsquo;s job to handle this correctly.</p>

<p>(You may be surprised that <code>BINARY_ADD</code> doesn&rsquo;t have arguments. We&rsquo;ll come back to this in a future installment, when we get to the interpreter itself.)</p>

<p>People often say that <code>dis</code> is a disassembler of python bytecode.  This is true enough &ndash; the <code>dis</code> module&rsquo;s docs say it &ndash; but <code>dis</code> knows about more than just the bytecode, too: it uses the whole code object to give us an understandable printout.  The middle three columns show information actually encoded in the bytecode, while the first and the last columns show other information.  Again, the bytecode itself is really limited: it&rsquo;s just a series of numbers, and things like names and constants are not a part of it.</p>

<p>How does the <code>dis</code> module get from bytes like <code>100</code> to names like <code>LOAD_CONST</code> and back?  Try to think of a way you&rsquo;d do it.  If you thought &ldquo;Well, you could have a list that has the byte names in the right order,&rdquo; or you thought, &ldquo;I guess you could have a dictionary where the names are the keys and the byte values are the values,&rdquo; then congratulations!  That&rsquo;s exactly what&rsquo;s going on.  The file <code>opcode.py</code> defines the list and the dictionary.  It&rsquo;s full of lines like these (<code>def_op</code> inserts the mapping in both the list and the dictionary):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">def_op</span><span class="p">(</span><span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>       <span class="c"># Index in const list</span>
</span><span class='line'><span class="n">def_op</span><span class="p">(</span><span class="s">&#39;BUILD_TUPLE&#39;</span><span class="p">,</span> <span class="mi">102</span><span class="p">)</span>      <span class="c"># Number of tuple items</span>
</span><span class='line'><span class="n">def_op</span><span class="p">(</span><span class="s">&#39;BUILD_LIST&#39;</span><span class="p">,</span> <span class="mi">103</span><span class="p">)</span>       <span class="c"># Number of list items</span>
</span><span class='line'><span class="n">def_op</span><span class="p">(</span><span class="s">&#39;BUILD_SET&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">)</span>        <span class="c"># Number of set items</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s even a friendly comment telling us what each byte&rsquo;s argument means.</p>

<p>Ok, now we understand what python bytecode is (and isn&rsquo;t), and how to use <code>dis</code> to make sense of it. In Part 4, we&rsquo;ll look at another example to see how Python can compile down to bytecode but still be a dynamic language.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/21/debugging-with-pstree/">Debugging with pstree</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/11/rejected-pycon-proposals/">Rejected PyCon Proposals</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/03/getting-started-with-python-internals/">Getting Started with Python Internals</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/02/the-cpython-peephole-optimizer-and-you/">The CPython Peephole Optimizer and You</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/11/of-syntax-warnings-and-symbol-tables/">Of Syntax Warnings and Symbol Tables</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - akaptur -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
